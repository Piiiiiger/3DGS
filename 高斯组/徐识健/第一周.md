# ç¬¬ä¸€å‘¨
## ç¬¬ä¸€æ¬¡å­¦ä¹ è®°å½•
# 1.åˆå§‹åŒ–ä¸å‚æ•°å®šä¹‰
## 1ï¸âƒ£ä»£ç 
```
class GaussianModel:
    # ... (setup_functions æ–¹æ³•) ...

    def __init__(self, sh_degree, optimizer_type="default"):
        self.active_sh_degree = 0
        self.optimizer_type = optimizer_type
        self.max_sh_degree = sh_degree
        self._xyz = torch.empty(0)
        self._features_dc = torch.empty(0)
        self._features_rest = torch.empty(0)
        self._scaling = torch.empty(0)
        self._rotation = torch.empty(0)
        self._opacity = torch.empty(0)
        self.max_radii2D = torch.empty(0)
        self.xyz_gradient_accum = torch.empty(0)
        self.denom = torch.empty(0)
        self.optimizer = None
        self.percent_dense = 0
        self.spatial_lr_scale = 0
        self.setup_functions()
```
### ==self._features_dc = torch.empty(0)==
<font color="#2DC26B">å®šä¹‰ï¼š</font>å­˜å‚¨æ‰€æœ‰3Dé«˜æ–¯ç‚¹çƒè°å‡½æ•°çš„ç›´æµ (DC) åˆ†é‡ï¼šä»£è¡¨æ¯ä¸ªé«˜æ–¯ç‚¹çš„åŸºç¡€é¢œè‰²ï¼Œä¸å—è§†è§’å˜åŒ–å½±å“çš„éƒ¨åˆ†ã€‚
<font color="#2DC26B">å½¢çŠ¶ï¼š</font>(N, 1, C)ï¼šæœ‰æ—¶ä¼šè¢«è½¬ç½®ï¼ˆN,C,1ï¼‰
### ==self._features_rest = torch.empty(0)==
<font color="#2DC26B">å®šä¹‰ï¼š</font>ç”¨äºå­˜å‚¨æ‰€æœ‰3Dé«˜æ–¯ç‚¹çƒè°å‡½æ•°çš„äº¤æµ (AC) åˆ†é‡ï¼Œå³é™¤äº†0é˜¶ä¹‹å¤–çš„é«˜é˜¶ç³»æ•°-æ•è·æ¯ä¸ªé«˜æ–¯ç‚¹é¢œè‰²éšè§†è§’å˜åŒ–çš„å¤æ‚å¤–è§‚
<font color="#2DC26B">å½¢çŠ¶</font>ï¼š(N, S, C)
<u>çƒè°å‡½æ•°ï¼š</u>
<font color="#2DC26B">SHé˜¶æ•°ï¼š</font>
**0é˜¶ (Degree 0)**: åªæœ‰ä¸€ä¸ªåŸºå‡½æ•°ï¼Œå®ƒåœ¨çƒé¢ä¸Šæ˜¯å¸¸æ•°ã€‚å¯¹åº”äºæ¼«åå°„é¢œè‰²æˆ–å¹³å‡é¢œè‰²ï¼Œä¸éšè§†è§’å˜åŒ–ã€‚è¿™å°±æ˜¯ `_features_dc` å­˜å‚¨çš„å†…å®¹ã€‚
**1é˜¶ (Degree 1)**: æœ‰ä¸‰ä¸ªåŸºå‡½æ•°ï¼Œå¯ä»¥è¡¨ç¤ºä¸€äº›ç®€å•çš„æ–¹å‘æ€§å˜åŒ–ï¼Œæ¯”å¦‚ä¸€ä¸ªæ–¹å‘æ›´äº®ï¼Œåæ–¹å‘æ›´æš—ã€‚
**æ›´é«˜é˜¶**: å¯ä»¥è¡¨ç¤ºæ›´å¤æ‚çš„é«˜å…‰ã€å„å‘å¼‚æ€§åå°„ç­‰ã€‚`_features_rest` å­˜å‚¨çš„å°±æ˜¯è¿™äº›1é˜¶åŠä»¥ä¸Šé˜¶æ•°çš„ç³»æ•°ã€‚
### ==self._scaling = torch.empty(0)==
![[Pasted image 20250513202151.png]]
<font color="#2DC26B">å®šä¹‰</font>ï¼šæ¯è¡Œä»£è¡¨ä¸€ä¸ªé«˜æ–¯ç‚¹åœ¨å±€éƒ¨åæ ‡ç³»ä¸‹ä¸‰ä¸ªä¸»è½´æ–¹å‘ä¸Šçš„ç¼©æ”¾å€¼    Wï¼šæ”¾ç¼©çŸ©é˜µ
<font color="#2DC26B">å½¢çŠ¶</font>ï¼šï¼ˆNï¼Œ3ï¼‰
ä¸æ—‹è½¬å‚æ•°ä¸€èµ·æ„å»ºåæ–¹å·®çŸ©é˜µ

### ==self._otation = torch.empty(0)==

<font color="#2DC26B">å®šä¹‰</font>ï¼š ç”¨äºå­˜å‚¨æ¯ä¸ª3Dé«˜æ–¯ç‚¹çš„æ—‹è½¬ä¿¡æ¯ï¼Œé€šå¸¸ä»¥å››å…ƒæ•° (quaternion) çš„å½¢å¼è¡¨ç¤ºã€‚
<font color="#2DC26B">å½¢çŠ¶</font>ï¼šï¼ˆNï¼Œ4ï¼‰
<font color="#2DC26B">ä½œç”¨ï¼š</font>å®šä¹‰äº†é«˜æ–¯æ¤­çƒåœ¨3Dç©ºé—´ä¸­çš„æœå‘ã€‚è¿™äº›å››å…ƒæ•°ä¼šç»è¿‡å½’ä¸€åŒ–å¤„ç†ä»¥ç¡®ä¿å®ƒä»¬æ˜¯æœ‰æ•ˆçš„å•ä½å››å…ƒæ•°ã€‚
<font color="#f79646">ä¸ºä½•ç”¨å››å…ƒæ•°</font>ï¼š
<font color="#4bacc6">æ¬§æ‹‰è§’</font> (Euler Angles): ä¾‹å¦‚ï¼Œç»•Xã€Yã€Zè½´åˆ†åˆ«æ—‹è½¬ä¸€å®šçš„è§’åº¦ã€‚ç›´è§‚ï¼Œä½†å­˜åœ¨ä¸‡å‘é” (Gimbal Lock) é—®é¢˜ï¼Œå¹¶ä¸”æ’å€¼ä¸å¹³æ»‘ã€‚
æ¬§æ‹‰è§’é€šè¿‡æŒ‡å®šç‰©ä½“ä¾æ¬¡ç»•ä¸‰ä¸ªè½´æ—‹è½¬ä¸€å®šçš„è§’åº¦æ¥å®šä¹‰æœ€ç»ˆçš„æœå‘ã€‚æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªå¸¸è§çš„é¡ºåºï¼šZYX (åèˆª Yaw, ä¿¯ä»° Pitch, ç¿»æ»š Roll)ã€‚
- **Yaw (åèˆª)**: ç»•ç‰©ä½“çš„åˆå§‹Yè½´æ—‹è½¬ã€‚
- **Pitch (ä¿¯ä»°)**: ç»•ç‰©ä½“**æ–°çš„**Xè½´ï¼ˆç»è¿‡Yawæ—‹è½¬åçš„Xè½´ï¼‰æ—‹è½¬ã€‚
- **Roll (ç¿»æ»š)**: ç»•ç‰©ä½“**æ›´æ–°çš„**Zè½´ï¼ˆç»è¿‡Yawå’ŒPitchæ—‹è½¬åçš„Zè½´ï¼‰æ—‹è½¬ã€‚


**æ—‹è½¬çŸ©é˜µ (Rotation Matrices)**: 3x3çš„æ­£äº¤çŸ©é˜µã€‚æ— ä¸‡å‘é”é—®é¢˜ï¼Œä½†æœ‰9ä¸ªå‚æ•°ï¼Œå…¶ä¸­åªæœ‰3ä¸ªè‡ªç”±åº¦ï¼Œå­˜åœ¨å†—ä½™ï¼Œä¸”ç›´æ¥ä¼˜åŒ–9ä¸ªå‚æ•°å¹¶ä¿æŒå…¶æ­£äº¤æ€§ä¹Ÿæ¯”è¾ƒå¤æ‚ã€‚

-**è½´-è§’è¡¨ç¤ºæ³• (Axis-Angle)**: ç”¨ä¸€ä¸ªæ—‹è½¬è½´ï¼ˆå•ä½å‘é‡ï¼‰å’Œä¸€ä¸ªæ—‹è½¬è§’åº¦æ¥è¡¨ç¤ºã€‚æ¯”è¾ƒç´§å‡‘ï¼Œä½†æ’å€¼å’Œç»„åˆæ—‹è½¬ä¸å¦‚å››å…ƒæ•°æ–¹ä¾¿ã€‚

**å››å…ƒæ•° (Quaternions)**: ä¸€ç§æ‰©å±•å¤æ•°çš„æ•°å­¦æ¦‚å¿µï¼Œç”±ä¸€ä¸ªå®éƒ¨å’Œä¸‰ä¸ªè™šéƒ¨ç»„æˆï¼Œé€šå¸¸è¡¨ç¤ºä¸º q=w+xi+yj+zk æˆ–å‘é‡å½¢å¼ [w,x,y,z]ã€‚

### ==ä¸ºä½•è¦åˆ†æˆä¸¤ä¸ªå‚æ•°ï¼š==
ç›´æ¥ä¼˜åŒ–åæ–¹å·®çŸ©é˜µçš„å…ƒç´ å¾ˆå›°éš¾ï¼Œå› ä¸ºéœ€è¦ä¿è¯å…¶ç‰©ç†ä¸Šçš„æœ‰æ•ˆæ€§ï¼ˆå³åŠæ­£å®šæ€§ï¼‰ã€‚æ¢¯åº¦ä¸‹é™ç­‰ä¼˜åŒ–ç®—æ³•å¾ˆéš¾ç›´æ¥æ–½åŠ è¿™æ ·çš„çº¦æŸï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿæ— æ•ˆçš„åæ–¹å·®çŸ©é˜µã€‚


## ç¬¬äºŒæ¬¡å­¦ä¹ è®°å½•

### self.denom = torch.empty(0)
- **å«ä¹‰**: `denom` æ˜¯ "denominator"ï¼ˆåˆ†æ¯ï¼‰çš„ç¼©å†™ã€‚å®ƒæ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä¸ `xyz_gradient_accum` (æ¢¯åº¦ç´¯åŠ å™¨) é…å¥—ä½¿ç”¨ã€‚
    
- **ä½œç”¨**: åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¯å½“ä¸€ä¸ªé«˜æ–¯çƒå¯¹æœ€ç»ˆå›¾åƒçš„æŸä¸ªåƒç´ æœ‰è´¡çŒ®æ—¶ï¼Œå®ƒçš„ä½ç½®æ¢¯åº¦å°±ä¼šè¢«ç´¯åŠ åˆ° `xyz_gradient_accum` ä¸­ï¼ŒåŒæ—¶å®ƒçš„ `denom` è®¡æ•°å™¨å°±ä¼šåŠ  1ã€‚
- 
    
- **ç›®çš„**: ä¸ºäº†è®¡ç®—**å¹³å‡æ¢¯åº¦**ã€‚è®ºæ–‡ä¸­æåˆ°ï¼Œè‡´å¯†åŒ–ï¼ˆdensificationï¼‰çš„ä¾æ®æ˜¯â€œè§†ç©ºé—´ä½ç½®æ¢¯åº¦çš„å¹³å‡å¹…åº¦â€ (average magnitude of view-space position gradients) ã€‚å¦‚æœåªçœ‹æ¢¯åº¦çš„æ€»å’Œï¼Œé‚£ä¹ˆä¸€ä¸ªç»å¸¸è¢«çœ‹åˆ°çš„ã€ä½ç½®åˆé€‚çš„é«˜æ–¯çƒå¯èƒ½ä¼šå› ä¸ºç´¯åŠ æ¬¡æ•°å¤šè€Œäº§ç”Ÿå¾ˆé«˜çš„æ€»æ¢¯åº¦ï¼Œè¿™ä¼šå¸¦æ¥è¯¯åˆ¤ã€‚å› æ­¤ï¼Œç”¨æ€»æ¢¯åº¦
    
    `xyz_gradient_accum` é™¤ä»¥è¢«çœ‹åˆ°çš„æ¬¡æ•° `denom`ï¼Œå¾—åˆ°å¹³å‡æ¢¯åº¦ `grads = self.xyz_gradient_accum / self.denom`ï¼Œæ‰èƒ½æ›´å‡†ç¡®åœ°åˆ¤æ–­è¿™ä¸ªé«˜æ–¯çƒæ‰€åœ¨åŒºåŸŸæ˜¯å¦çœŸçš„éœ€è¦è¢«â€œè‡´å¯†åŒ–â€ã€‚
### self.optimizer = None
- **å«ä¹‰**: è¿™æ˜¯PyTorchä¸­çš„ä¼˜åŒ–å™¨å¯¹è±¡ã€‚
    
- **ä½œç”¨**: ä¼˜åŒ–å™¨çš„ä»»åŠ¡æ˜¯åœ¨æ¯æ¬¡åå‘ä¼ æ’­è®¡ç®—å‡ºæ¢¯åº¦åï¼Œæ ¹æ®è‡ªèº«çš„ä¼˜åŒ–ç®—æ³•ï¼ˆä¾‹å¦‚Adamï¼‰æ¥æ›´æ–°æ¨¡å‹çš„æ‰€æœ‰å¯å­¦ä¹ å‚æ•°ï¼ˆå¦‚ `_xyz`, `_scaling` ç­‰ï¼‰ã€‚
    
- **ä¸ºä»€ä¹ˆåˆå§‹ä¸º`None`**: åœ¨`__init__`é˜¶æ®µï¼Œæ¨¡å‹æ¡†æ¶åˆšåˆšæ­å»ºå¥½ï¼Œä½†è¿˜æ²¡æœ‰ä»ç‚¹äº‘åŠ è½½ä»»ä½•å®é™…çš„é«˜æ–¯çƒæ•°æ®ï¼Œæ‰€æœ‰å‚æ•°å¼ é‡éƒ½æ˜¯ç©ºçš„ã€‚ä¼˜åŒ–å™¨éœ€è¦ç»‘å®šåˆ°å…·ä½“çš„å‚æ•°ä¸Šæ‰èƒ½å·¥ä½œï¼Œå› æ­¤ä¸èƒ½åœ¨æ­¤æ—¶åˆ›å»ºã€‚å®ƒä¼šåœ¨åç»­çš„`training_setup`å‡½æ•°ä¸­ï¼Œå½“æ‰€æœ‰å‚æ•°éƒ½ä»ç‚¹äº‘åˆå§‹åŒ–å®Œæ¯•åï¼Œæ‰è¢«æ­£å¼åˆ›å»ºå’Œèµ‹å€¼ã€‚

### self.percent_dense = 0
- **å«ä¹‰**: è¿™ä¸ªå‚æ•°æ˜¯ç”¨æ¥åŒºåˆ†â€œå°â€é«˜æ–¯çƒå’Œâ€œå¤§â€é«˜æ–¯çƒçš„ä¸€ä¸ªé˜ˆå€¼å› å­ã€‚å®ƒåœ¨`training_setup`å‡½æ•°ä¸­ä¼šè¢«èµ‹äºˆä¸€ä¸ªæ¥è‡ªè®­ç»ƒå‚æ•°çš„å®é™…å€¼ã€‚
    
- **ä½œç”¨**: å®ƒæ˜¯å®ç°è®ºæ–‡ä¸­ä¸¤ç§ä¸åŒè‡´å¯†åŒ–ç­–ç•¥çš„å…³é”®ã€‚è®ºæ–‡æåˆ°ï¼Œå¯¹äºâ€œæ¬ é‡å»ºâ€åŒºåŸŸçš„å°é«˜æ–¯çƒï¼Œé‡‡ç”¨**å…‹éš†ï¼ˆCloneï¼‰** ç­–ç•¥ï¼›å¯¹äºâ€œè¿‡é‡å»ºâ€åŒºåŸŸçš„å¤§é«˜æ–¯çƒï¼Œé‡‡ç”¨**åˆ†è£‚ï¼ˆSplitï¼‰** ç­–ç•¥ ã€‚z
- **==ä½œç”¨äºŒ==**ï¼šé™åˆ¶å¤§è‡´é™åˆ¶é«˜æ–¯çƒçš„å¤§å°
    
- **å¦‚ä½•å·¥ä½œ**:
    
    - åœ¨`densify_and_clone`ä¸­ï¼Œåªæœ‰å°ºå¯¸**å°äº** `percent_dense * scene_extent` çš„é«˜æ–¯çƒæ‰ä¼šè¢«è€ƒè™‘å…‹éš†ã€‚
        
    - åœ¨`densify_and_split`ä¸­ï¼Œåªæœ‰å°ºå¯¸**å¤§äº** `percent_dense * scene_extent` çš„é«˜æ–¯çƒæ‰ä¼šè¢«è€ƒè™‘åˆ†è£‚ã€‚ `scene_extent`æ˜¯æ•´ä¸ªåœºæ™¯çš„å¤§è‡´èŒƒå›´ï¼Œæ‰€ä»¥è¿™ä¸ªå‚æ•°å®é™…ä¸Šæ˜¯æ ¹æ®é«˜æ–¯çƒå°ºå¯¸ç›¸å¯¹äºæ•´ä¸ªåœºæ™¯çš„æ¯”ä¾‹æ¥åšåˆ¤æ–­çš„

### self.spatial_lr_scale = 0
- **å«ä¹‰**: â€œç©ºé—´å­¦ä¹ ç‡ç¼©æ”¾å› å­â€ (Spatial Learning Rate Scale)ã€‚
    
- **ä½œç”¨**: è¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥è°ƒæ•´é«˜æ–¯çƒ**ä½ç½®ï¼ˆxyzï¼‰å­¦ä¹ ç‡**çš„ç¼©æ”¾ç³»æ•°ã€‚
    
- **ç›®çš„**: å…è®¸ç‹¬ç«‹æ§åˆ¶é«˜æ–¯çƒâ€œç§»åŠ¨å¿«æ…¢â€ï¼ˆä½ç½®å˜åŒ–ï¼‰å’Œå…¶ä»–å±æ€§â€œå˜åŒ–å¿«æ…¢â€ï¼ˆå¦‚é¢œè‰²ã€å½¢çŠ¶ã€é€æ˜åº¦å˜åŒ–ï¼‰ã€‚åœ¨`training_setup`ä¸­è®¾ç½®ä¼˜åŒ–å™¨æ—¶ï¼Œä½ç½®å‚æ•°`_xyz`çš„å­¦ä¹ ç‡ä¼šä¹˜ä»¥è¿™ä¸ªç¼©æ”¾å› å­ï¼š`training_args.position_lr_init * self.spatial_lr_scale`ã€‚è¿™éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºåœ¨ä¸€äº›éå¸¸å¤§çš„åœºæ™¯ä¸­ï¼Œå¦‚æœä½ç½®å­¦ä¹ ç‡è¿‡é«˜ï¼Œé«˜æ–¯çƒåœ¨è®­ç»ƒåˆæœŸå¯èƒ½ä¼šç§»åŠ¨å¾—è¿‡å¿«ï¼Œå¯¼è‡´ä¸ç¨³å®šã€‚é€šè¿‡è¿™ä¸ªç¼©æ”¾å› å­ï¼Œå¯ä»¥æ ¹æ®åœºæ™¯çš„å¤§å°æ¥é€‚å½“è°ƒæ•´ä½ç½®å­¦ä¹ ç‡ï¼Œä»¥ä¿è¯è®­ç»ƒçš„ç¨³å®šæ€§å’Œæ”¶æ•›æ•ˆæœ ã€‚


## ç¬¬ä¸‰æ¬¡å­¦ä¹ è®°å½•
ä»Šå¤©ä¸»è¦ä¾§é‡äºè¿›è¡Œé€æ˜åº¦ç­›é€‰
è®¾ç½®äº†ä¸€ä¸ªç­›é€‰æ‰ä½é€æ˜åº¦çš„æ–¹æ³•ï¼Œä½†æ˜¯æ€»ä½“æ„Ÿè§‰æ•ˆæœä¸€èˆ¬

#### train.py

- è¿‡æ»¤æ‰é¢œè‰²æ¥è¿‘é»‘è‰²çš„é«˜æ–¯ç‚¹   é”™è¯¯
```
print(gaussians.colors)
valid_points = torch.any(gaussians.colors > 0.1, dim=1) Â # é¢œè‰²é˜ˆå€¼ä¸º 0.1ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
gaussians.positions = gaussians.positions[valid_points]
gaussians.colors = gaussians.colors[valid_points]
gaussians.max_radii2D = gaussians.max_radii2D[valid_points]
```
#### __init__.py
- self.densify_until_iter = 1000
- self.sh_degree = 0

## ç¬¬å››æ¬¡å­¦ä¹ è®°å½•
# 2.å‚æ•°çš„æ¿€æ´»ä¸è·å–
## 2.1ç›®çš„
æ ¸å¿ƒé—®é¢˜ï¼šä¸ºä»€ä¹ˆéœ€è¦â€œæ¿€æ´»â€ï¼Ÿ

è¿™ä¸ªè®¾è®¡çš„å‡ºå‘ç‚¹æ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªçŸ›ç›¾ï¼š

- **ä¼˜åŒ–å™¨çš„ä¸–ç•Œ**ï¼šåƒAdamè¿™æ ·çš„ä¼˜åŒ–å™¨ï¼Œåœ¨æ›´æ–°å‚æ•°æ—¶æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå®ƒå¯ä»¥æŠŠä¸€ä¸ªæ•°å€¼ä»0.1æ›´æ–°åˆ°-100ã€‚å®ƒåœ¨æ— çº¦æŸçš„æ•°å­¦ç©ºé—´ä¸­å·¥ä½œæ•ˆç‡æœ€é«˜ã€‚
    
- **ç‰©ç†ä¸–ç•Œ**ï¼šåœºæ™¯ä¸­çš„å±æ€§æ˜¯æœ‰ä¸¥æ ¼çº¦æŸçš„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç‰©ä½“çš„å°ºå¯¸ï¼ˆç¼©æ”¾ï¼‰å¿…é¡»æ˜¯æ­£æ•°ï¼›ä¸é€æ˜åº¦å¿…é¡»åœ¨0åˆ°1ä¹‹é—´ï¼›æ—‹è½¬å¿…é¡»æ˜¯æœ‰æ•ˆçš„åˆšä½“å˜æ¢ï¼Œä¸èƒ½åŒ…å«æ‹‰ä¼¸æˆ–æŒ¤å‹ã€‚
    

å¦‚æœç›´æ¥ä¼˜åŒ–æœ‰ç‰©ç†æ„ä¹‰çš„å‚æ•°ï¼ˆæ¯”å¦‚å°ºå¯¸ï¼‰ï¼Œä¼˜åŒ–å™¨ä¸€æ¬¡æ›´æ–°å°±å¯èƒ½æŠŠå®ƒå˜æˆä¸€ä¸ªæ— æ•ˆçš„è´Ÿæ•°ï¼Œå¯¼è‡´æ•´ä¸ªè®¡ç®—å´©æºƒã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä»£ç é‡‡ç”¨äº†ä¸€ç§â€œåŒé‡ä¸–ç•Œâ€çš„æ¶æ„ã€‚å®ƒåœ¨å†…éƒ¨å­˜å‚¨ä¸€ç»„æ— çº¦æŸçš„åŸå§‹å‚æ•°ï¼ˆå¦‚`_scaling`, `_opacity`ï¼‰ï¼Œç„¶åå®šä¹‰ä¸€å¥—â€œè§„åˆ™â€ï¼Œå°†è¿™äº›åŸå§‹å‚æ•°â€œç¿»è¯‘â€æˆ–â€œæ¿€æ´»â€æˆç¬¦åˆç‰©ç†çº¦æŸçš„å±æ€§ã€‚
## 2.2`setup_functions(self)`: å®šä¹‰â€œç¿»è¯‘è§„åˆ™â€
### 2.2.1 ä»£ç 
```python
class GaussianModel:

    def setup_functions(self):
        def build_covariance_from_scaling_rotation(scaling, scaling_modifier, rotation):
            L = build_scaling_rotation(scaling_modifier * scaling, rotation)
            actual_covariance = L @ L.transpose(1, 2)
            symm = strip_symmetric(actual_covariance)
            return symm
        
        self.scaling_activation = torch.exp
        self.scaling_inverse_activation = torch.log

        self.covariance_activation = build_covariance_from_scaling_rotation

        self.opacity_activation = torch.sigmoid
        self.inverse_opacity_activation = inverse_sigmoid

        self.rotation_activation = torch.nn.functional.normalize
```

### 2.2.2 build_covariance_from_scaling_rotation
#### (1)ä½œç”¨
å®ç°
$$\Sigma = RSS^T R^T$$
#### (2)build_scaling_rotation
å‚æ•°ï¼šscaling_modifier+scaling+rotation
ä½œç”¨ï¼šscaling_modifierå¯ä»¥ä¸´æ—¶è°ƒæ•´é«˜æ–¯ç‚¹å¤§å°
scaling:ä¸‰ç»´å‘é‡
rotaionï¼šå››å…ƒæ•°
#### (3)actual_covariance = L @ L.transpose(1, 2)
è§£å†³$$L@L^T = (R@S)@(R@S)^T = R@S@S^T@R^T$$transpose(1, 2)äº¤æ¢1åˆ—å’Œ2åˆ—


#### (4)**`symm = strip_symmetric(actual_covariance)`**
èŠ‚çº¦æ•ˆç‡ï¼Œå°†3X3çŸ©é˜µçš„ä¿å­˜çš„å¯¹ç§°çŸ©é˜µè½¬åŒ–ä¸º6å…ƒç´ 
2è¿™æ ·åšå¯ä»¥å‡å°‘éœ€è¦ä¼ è¾“åˆ°GPUæ¸²æŸ“å™¨çš„æ•°æ®é‡ï¼Œæé«˜æ¸²æŸ“æ•ˆç‡ã€‚

## 2.3 captureå’Œrestore
#### 2.3.1`capture(self)`: åˆ¶ä½œä¸€ä¸ªâ€œå®Œæ•´å¿«ç…§â€ ğŸ“¸
è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯**æ•è·**å½“å‰æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­çš„**æ‰€æœ‰å…³é”®çŠ¶æ€**ï¼Œå¹¶å°†å®ƒä»¬æ‰“åŒ…æˆä¸€ä¸ªå…ƒç»„ï¼ˆtupleï¼‰è¿”å›ã€‚

å®ƒä¸ä»…ä»…ä¿å­˜äº†é«˜æ–¯çƒæœ¬èº«çš„å‡ ä½•ä¸é¢œè‰²å‚æ•°ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒè¿˜ä¿å­˜äº†ä¸**è®­ç»ƒè¿‡ç¨‹æœ¬èº«ç›¸å…³çš„çŠ¶æ€**ã€‚

å…·ä½“æ¥è¯´ï¼Œå®ƒæ‰“åŒ…äº†ä»¥ä¸‹ä¿¡æ¯:

- **æ¨¡å‹æ ¸å¿ƒå‚æ•°**: `_xyz`, `_features_dc`, `_features_rest`, `_scaling`, `_rotation`, `_opacity`ã€‚
    
- **è®­ç»ƒè¾…åŠ©çŠ¶æ€**:
    
    - `active_sh_degree`: å½“å‰ä½¿ç”¨çš„çƒè°å‡½æ•°é˜¶æ•°ã€‚
        
    - `max_radii2D`: ç”¨äºå‰ªæåˆ¤æ–­çš„2DåŠå¾„ã€‚
        
    - `xyz_gradient_accum`, `denom`: ç”¨äºè‡ªé€‚åº”å¯†åº¦æ§åˆ¶çš„æ¢¯åº¦ç´¯åŠ å™¨å’Œåˆ†æ¯ã€‚
        
    - `spatial_lr_scale`: ç©ºé—´å­¦ä¹ ç‡ç¼©æ”¾å› å­ã€‚
        
- **ä¼˜åŒ–å™¨çŠ¶æ€ (æœ€å…³é”®)**: `self.optimizer.state_dict()`ã€‚è¿™ä¼šè¿”å›ä¸€ä¸ªåŒ…å«ä¼˜åŒ–å™¨å†…éƒ¨çŠ¶æ€çš„å­—å…¸ï¼Œæ¯”å¦‚Adamä¼˜åŒ–å™¨ä¸­æ¯ä¸ªå‚æ•°çš„åŠ¨é‡ï¼ˆmomentumï¼‰å’ŒäºŒé˜¶çŸ©ä¼°è®¡ã€‚
    

**ç›®çš„**: åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„â€œå­˜æ¡£ç‚¹â€ã€‚åªä¿å­˜æ¨¡å‹å‚æ•° `_xyz` ç­‰æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºè¦æ— ç¼åœ°ç»§ç»­è®­ç»ƒï¼Œå¿…é¡»æ¢å¤ä¼˜åŒ–å™¨ä¹‹å‰çš„çŠ¶æ€ã€‚å¦åˆ™ï¼Œä¼˜åŒ–å™¨ä¼šä¸¢å¤±åŠ¨é‡ï¼Œè®­ç»ƒçš„æ”¶æ•›é€Ÿåº¦å’Œè·¯å¾„éƒ½ä¼šå—å½±å“ã€‚

---

### `restore(self)`: ä»â€œå¿«ç…§â€ä¸­æ¢å¤ ğŸ’¾

è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯æ¥æ”¶ä¸€ä¸ªç”± `capture` æ–¹æ³•åˆ›å»ºçš„â€œå¿«ç…§â€æ•°æ®ï¼Œå¹¶å°†æ¨¡å‹çš„**æ‰€æœ‰çŠ¶æ€æ¢å¤åˆ°å­˜æ¡£æ—¶çš„é‚£ä¸€åˆ»**ã€‚

å®ƒçš„æ‰§è¡Œæµç¨‹éå¸¸ä¸¥è°¨ï¼š

1. **è§£åŒ…æ•°æ®**: å®ƒé¦–å…ˆå°†ä¼ å…¥çš„å…ƒç»„ `model_args` è§£åŒ…ï¼ŒæŠŠä¿å­˜çš„å‚æ•°å’ŒçŠ¶æ€å€¼èµ‹ç»™å½“å‰æ¨¡å‹çš„å¯¹åº”å±æ€§ã€‚
    
2. **é‡å»ºä¼˜åŒ–å™¨**: å®ƒè°ƒç”¨ `self.training_setup(training_args)`ã€‚è¿™ä¸€æ­¥ä¼šæ ¹æ®å½“å‰çš„å‚æ•°é‡æ–°åˆ›å»ºä¸€ä¸ª**å…¨æ–°çš„ã€æ²¡æœ‰å†…éƒ¨çŠ¶æ€**çš„ä¼˜åŒ–å™¨å®ä¾‹ã€‚
    
3. **æ¢å¤è®­ç»ƒçŠ¶æ€**: å°†è§£åŒ…å¾—åˆ°çš„ `xyz_gradient_accum` å’Œ `denom` èµ‹å€¼ç»™æ¨¡å‹ã€‚
    
4. **åŠ è½½ä¼˜åŒ–å™¨çŠ¶æ€**: æœ€åï¼Œä¹Ÿæ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼Œå®ƒè°ƒç”¨ `self.optimizer.load_state_dict(opt_dict)`ã€‚è¿™ä¸ªå‘½ä»¤ä¼šå°†å­˜æ¡£ä¸­çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆåŠ¨é‡ç­‰ï¼‰åŠ è½½åˆ°ç¬¬2æ­¥åˆ›å»ºçš„é‚£ä¸ª**æ–°ä¼˜åŒ–å™¨**ä¸­ã€‚
    

**ç›®çš„**: ç¡®ä¿æ¨¡å‹ä¸ä»…å‚æ•°å’Œå­˜æ¡£æ—¶ä¸€æ¨¡ä¸€æ ·ï¼Œè¿ä¼˜åŒ–å™¨çš„â€œè®­ç»ƒèŠ‚å¥â€å’Œâ€œæƒ¯æ€§â€ä¹Ÿå®Œå…¨æ¢å¤ã€‚è¿™æ ·ï¼Œä½ ä¸­æ–­è®­ç»ƒå†ä»è¿™ä¸ªå­˜æ¡£ç‚¹ç»§ç»­æ—¶ï¼Œå…¶æ•ˆæœå°±å’Œä»æœªä¸­æ–­è¿‡è®­ç»ƒå®Œå…¨ä¸€æ ·ã€‚

---

## 2.4è£…é¥°å™¨
æä¾›ä¸€ä¸ª**ç»Ÿä¸€ã€å®‰å…¨ã€åªè¯»çš„æ¥å£**ï¼Œè®©å¤–éƒ¨ä»£ç ï¼ˆå¦‚æ¸²æŸ“å™¨ï¼‰å¯ä»¥è·å–é«˜æ–¯çƒçš„**ç‰©ç†å±æ€§**ï¼Œè€Œä¸æ˜¯ç›´æ¥æ¥è§¦å†…éƒ¨å­˜å‚¨çš„ã€æœªç»å¤„ç†çš„**åŸå§‹å‚æ•°**ã€‚

### 2.4.1 ä»£ç 
```python
@property
def get_scaling(self):
	return self.scaling_activation(self._scaling)
@property
def get_rotation(self):
	return self.rotation_activation(self._rotation)
@property
def get_xyz(self):
	return self._xyz
@property
def get_features(self):
	features_dc = self._features_dc
	features_rest = self._features_rest
	return torch.cat((features_dc, features_rest), dim=1)
@property
def get_features_dc(self):
	return self._features_dc
@property
def get_features_rest(self):
	return self._features_rest
@property
def get_opacity(self):
	return self.opacity_activation(self._opacity)
@property
def get_exposure(self):
	return self._exposure
```
## 2.5 è·å–å…¶ä»–å‚æ•°
### 2.5.1 get_exposure_from_name
```python
def get_exposure_from_name(self, image_name):

	if self.pretrained_exposures is None:
	
		return self._exposure[self.exposure_mapping[image_name]]
	
	else:
	
		return self.pretrained_exposures[image_name]
```
**ä½œç”¨**: æ ¹æ®è¾“å…¥çš„**å›¾åƒæ–‡ä»¶å**ï¼Œè·å–è¯¥å›¾åƒå¯¹åº”çš„**æ›å…‰è¡¥å¿å‚æ•°**ã€‚
è¿™ä¸ªå‡½æ•°å†…éƒ¨æœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š
1. **å½“ `self.pretrained_exposures` ä¸º `None` æ—¶ (æ­£å¸¸è®­ç»ƒæ¨¡å¼)**:
    
    - å®ƒä¼šä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„ `self.exposure_mapping` å­—å…¸ï¼Œå°† `image_name` è½¬æ¢æˆä¸€ä¸ªç´¢å¼•å·ã€‚
        
    - ç„¶åç”¨è¿™ä¸ªç´¢å¼•å·ï¼Œä»æ­£åœ¨å­¦ä¹ çš„ `_exposure` å‚æ•°å¼ é‡ä¸­ï¼Œå–å‡ºä¸“å±äºè¿™å¼ å›¾åƒçš„é‚£ä¸ª 3x4 å˜æ¢çŸ©é˜µå¹¶è¿”å›ã€‚
        
2. **å½“ `self.pretrained_exposures` ä¸ä¸º `None` æ—¶ (ä½¿ç”¨é¢„è®¾å€¼æ¨¡å¼)**:
    
    - è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ `load_ply` å‡½æ•°ä»å¤–éƒ¨ `exposure.json` æ–‡ä»¶ä¸­æˆåŠŸåŠ è½½äº†é¢„å…ˆè®¡ç®—å¥½çš„æ›å…‰å€¼ä¹‹åã€‚
        
    - å‡½æ•°ä¼šç›´æ¥åœ¨ `self.pretrained_exposures` è¿™ä¸ªå­—å…¸é‡ŒæŸ¥æ‰¾å¹¶è¿”å›å¯¹åº” `image_name` çš„æ›å…‰å‚æ•°ï¼Œè€Œ**ä¸æ˜¯**ä½¿ç”¨æ¨¡å‹å†…éƒ¨æ­£åœ¨å­¦ä¹ çš„ `_exposure`ã€‚
        

**æ€»ç»“**: è¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„è·å–å™¨ï¼Œå®ƒèƒ½æ ¹æ®å½“å‰æ˜¯éœ€è¦**åŠ¨æ€å­¦ä¹ **æ›å…‰è¿˜æ˜¯**ä½¿ç”¨å›ºå®šé¢„è®¾å€¼**ï¼Œæ¥æä¾›æ­£ç¡®çš„æ›å…‰è¡¥å¿çŸ©é˜µã€‚

# 3.ä»ç‚¹äº‘åˆå§‹åŒ–åœºæ™¯
## 3.1 å‚æ•°ä»‹ç»
- pcd : BasicPointCloud:    åŒ…æ‹¬ä½ç½®ä¿¡æ¯å’Œé¢œè‰²ä¿¡æ¯
- cam_infos : int ç›¸æœºä¿¡æ¯
- spatial_lr_scale : float ï¼šæ ¹æ®pcdè®¡ç®—å‡ºçš„å°ºå¯¸ä¿¡æ¯
## 3.2 åˆå§‹åŒ–å‡†å¤‡
```python
self.spatial_lr_scale = spatial_lr_scale
fused_point_cloud = torch.tensor(np.asarray(pcd.points)).float().cuda()
fused_color = RGB2SH(torch.tensor(np.asarray(pcd.colors)).float().cuda())
```
## 3.3 ç¼©æ”¾å’Œæ—‹è½¬çš„åˆå§‹åŒ–
```python
dist2 = torch.clamp_min(distCUDA2(torch.from_numpy(np.asarray(pcd.points)).float().cuda()), 0.0000001)## è®¡ç®—ç‚¹äº‘ä¹‹é—´çš„è·ç¦»å¹¶ä¸”é˜²æ­¢è·ç¦»è¿‡å°æˆ–é‡å ï¼Œå¦‚æœè·ç¦»è¿‡å°ï¼Œé‚£ä¹ˆå°±è®¾ç½®è·ç¦»ä¸ºæŒ‡å®šå€¼

scales = torch.log(torch.sqrt(dist2))[...,None].repeat(1, 3) ## è®¡ç®—ç¼©æ”¾å‚æ•°ï¼Œä½¿ç”¨å¯¹æ•°ç¼©æ”¾è·ç¦»,ä½¿ç”¨log çš„åŸå› æ˜¯å› ä¸ºæ¿€æ´»å‡½æ•°æ˜¯expï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å¯¹è·ç¦»è¿›è¡Œå¯¹æ•°ç¼©æ”¾

rots = torch.zeros((fused_point_cloud.shape[0], 4), device="cuda")

rots[:, 0] = 1
```

### 3.3.1æ”¾ç¼©ä¸¾ä¾‹
```
åŸå§‹ dist2: tensor([25., 4., 16.]) 
åŸå§‹ dist2 å½¢çŠ¶: torch.Size([3]) 
æœ€ç»ˆ scales: tensor(
[
[1.6094, 1.6094, 1.6094], 
[0.6931, 0.6931, 0.6931], 
[1.3863, 1.3863, 1.3863]]) 
æœ€ç»ˆ scales å½¢çŠ¶: torch.Size([3, 3]) 
```

[n,3]åˆ†åˆ«å¯¹åº”x,y,zè½´
### 3.3.2æ—‹è½¬ä¸¾ä¾‹
```
[[1.0, 0.0, 0.0, 0.0], # P0 å¯¹åº”çš„åˆå§‹ _rotation å‚æ•° 
[1.0, 0.0, 0.0, 0.0], # P1 å¯¹åº”çš„åˆå§‹ _rotation å‚æ•° 
[1.0, 0.0, 0.0, 0.0]] # P2 å¯¹åº”çš„åˆå§‹ _rotation å‚æ•°
```
è¡¨ç¤ºå•ä½æ—‹è½¬

### 3.3.3æ³¨å†Œå¯å­¦ä¹ å‚æ•°
```python
self._xyz = nn.Parameter(fused_point_cloud.requires_grad_(True))
self._features_dc = nn.Parameter(features[:,:,0:1].transpose(1, 2).contiguous().requires_grad_(True))
self._features_rest = nn.Parameter(features[:,:,1:].transpose(1, 2).contiguous().requires_grad_(True))
self._scaling = nn.Parameter(scales.requires_grad_(True))
self._rotation = nn.Parameter(rots.requires_grad_(True))
self._opacity = nn.Parameter(opacities.requires_grad_(True))
self.max_radii2D = torch.zeros((self.get_xyz.shape[0]), device="cuda")
self.exposure_mapping = {cam_info.image_name: idx for idx, cam_info in enumerate(cam_infos)}
self.pretrained_exposures = None
exposure = torch.eye(3, 4, device="cuda")[None].repeat(len(cam_infos), 1, 1)
self._exposure = nn.Parameter(exposure.requires_grad_(True))
```

#### (1)nn.Parameter
- **ä½œç”¨**: `torch.nn.Parameter` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼Œå®ƒåƒä¸€ä¸ªâ€œæ ‡ç­¾â€ï¼Œç”¨æ¥å‘Šè¯‰PyTorchï¼šâ€œè¿™ä¸ªå¼ é‡ï¼ˆTensorï¼‰æ˜¯æˆ‘æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒéœ€è¦è¢«å­¦ä¹ å’Œæ›´æ–°ã€‚è¯·åœ¨è®­ç»ƒæ—¶è·Ÿè¸ªå®ƒçš„æ¢¯åº¦ã€‚â€
#### (2)contiguous()
- **ç»è¿‡ `.transpose()` æ“ä½œåçš„å¼ é‡**ï¼šè¿™æœ¬ä¹¦çš„ç‰©ç†é¡µç è¿˜æ˜¯ 1, 2, 3, ...ï¼Œä½†ä½ æ‹¿åˆ°äº†ä¸€å¼ â€œé˜…è¯»é¡ºåºå¡â€ï¼Œä¸Šé¢å†™ç€â€œå…ˆè¯»ç¬¬1é¡µï¼Œå†è¯»ç¬¬50é¡µï¼Œå†è¯»ç¬¬2é¡µ...â€ã€‚ä½ ä¾ç„¶èƒ½è¯»å®Œæ•´æœ¬ä¹¦ï¼Œä½†éœ€è¦ä¸åœåœ°æ¥å›è·³è½¬ï¼Œ**æ•ˆç‡å¾ˆä½**ã€‚è¿™æ—¶ï¼Œè¿™æœ¬ä¹¦åœ¨é€»è¾‘ä¸Šæ˜¯è½¬ç½®è¿‡çš„ï¼Œä½†åœ¨å†…å­˜ä¸­æ˜¯**â€œä¸è¿ç»­çš„â€ï¼ˆNon-contiguousï¼‰**ã€‚
    
- **`.contiguous()` å‡½æ•°**ï¼šå®ƒçš„ä½œç”¨å°±åƒä¸€ä¸ªå›¾ä¹¦ç®¡ç†å‘˜ï¼Œä»–ä¼šæ ¹æ®ä½ çš„â€œé˜…è¯»é¡ºåºå¡â€ï¼ŒæŠŠä¹¦çš„é¡µé¢**é‡æ–°ç‰©ç†æ’åº**ï¼Œæ•´ç†æˆä¸€æœ¬å…¨æ–°çš„ã€é¡µç æŒ‰æ–°é¡ºåº 1, 50, 2, ... æ’åˆ—çš„ä¹¦ã€‚è¿™æ ·ä½ å†è¯»èµ·æ¥å°±åˆå˜å¾—å¾ˆå¿«äº†ã€‚

#### (3)exposure_mapping
ç›®çš„ï¼š
æ¨¡å‹çš„æ›å…‰å‚æ•° `_exposure` æ˜¯ä¸€ä¸ª `(N, 3, 4)` çš„å¤§å¼ é‡ï¼Œå…¶ä¸­ `N` æ˜¯ç›¸æœºçš„æ€»æ•°ã€‚è¦è·å–ç¬¬ä¸€å¼ ç…§ç‰‡çš„æ›å…‰å‚æ•°ï¼Œä½ éœ€è¦è®¿é—® `_exposure[0]`ï¼›è¦è·å–ç¬¬äºŒå¼ çš„ï¼Œéœ€è¦è®¿é—® `_exposure[1]`ã€‚

åœ¨è®­ç»ƒæ—¶ï¼Œç¨‹åºçŸ¥é“å½“å‰å¤„ç†çš„æ˜¯å“ªå¼ å›¾ç‰‡ï¼ˆæ¯”å¦‚`"003.jpg"`ï¼‰ï¼Œä½†å®ƒä¸çŸ¥é“è¿™å¼ å›¾ç‰‡å¯¹åº”çš„æ˜¯ç¬¬å‡ ä¸ªæ›å…‰å‚æ•°ã€‚

è¿™ä¸ª `exposure_mapping` å­—å…¸å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ç¨‹åºå¯ä»¥é€šè¿‡ `idx = self.exposure_mapping["003.jpg"]` ç¬é—´æŸ¥åˆ°å®ƒçš„ç´¢å¼•æ˜¯ `2`ï¼Œç„¶åå°±èƒ½å‡†ç¡®åœ°ä» `_exposure[2]` ä¸­å–å‡ºæ­£ç¡®çš„æ›å…‰å‚æ•°äº†ã€‚
`cam_info.image_name: idx`: è¿™å®šä¹‰äº†å­—å…¸çš„â€œé”®å€¼å¯¹â€ã€‚

- **é”® (key)**: `cam_info.image_name` (å›¾åƒçš„æ–‡ä»¶å)
    
- **å€¼ (value)**: `idx` (è¯¥å›¾åƒåœ¨åˆ—è¡¨ä¸­çš„ç´¢å¼•å·)
æœ€åå½¢æˆ
```
{
    "001.jpg": 0,
    "002.jpg": 1,
    "003.jpg": 2,
    # ...
}
